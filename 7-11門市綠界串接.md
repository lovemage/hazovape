# 7-11門市綠界串接技術文檔

## 概述

本系統使用綠界科技(ECPay)物流API，提供7-ELEVEN超商交貨便C2C (Consumer to Consumer)門市選擇功能。用戶可通過電子地圖選擇取貨門市，系統會自動將選擇的門市資訊填入結帳表單。

## 技術架構

### 1. 系統組件

- **後端服務**: ECPay物流API整合服務
- **前端組件**: StoreSelector React組件
- **回調處理**: 多重通訊機制
- **資料橋接**: localStorage + postMessage + URL重定向

### 2. 技術流程

```
用戶點擊選擇門市 → 開啟ECPay地圖彈窗 → 用戶選擇門市 → ECPay回調處理 → 門市資料回傳主頁面 → 自動填入表單
```

## API配置

### 環境設定

**正式環境配置**:
```javascript
// backend/services/ecpayLogistics.js
merchantID: '3466445'  // 正式環境商店代號
hashKey: 'u0mKtzqI07btGNNT'  // 正式環境HashKey
hashIV: 'ZjAbsWWZUvOu8NA0'  // 正式環境HashIV
mapUrl: 'https://logistics.ecpay.com.tw/Express/map'  // 正式環境地圖API
```

**環境變數**:
```bash
ECPAY_MERCHANT_ID=3466445
ECPAY_HASH_KEY=u0mKtzqI07btGNNT
ECPAY_HASH_IV=ZjAbsWWZUvOu8NA0
```

### 物流類型

- **LogisticsType**: `CVS` (超商)
- **LogisticsSubType**: `UNIMARTC2C` (7-ELEVEN超商交貨便C2C)
- **IsCollection**: `N` (不代收貨款)

## 核心功能實現

### 1. ECPay API服務 (`backend/services/ecpayLogistics.js`)

#### CheckMacValue生成
使用ECPay官方7步驟檢查碼生成流程：
```javascript
generateCheckMacValue(params) {
  // 1. 移除CheckMacValue並按A-Z排序
  // 2. 串連參數: param1=value1&param2=value2
  // 3. 加入HashKey和HashIV
  // 4. URL編碼
  // 5. 轉小寫
  // 6. 字元替換(.NET規範)
  // 7. MD5加密並轉大寫
}
```

#### 地圖參數生成
```javascript
generateMapParams(options) {
  const params = {
    MerchantID: this.merchantID,
    MerchantTradeNo: merchantTradeNo, // 唯一交易編號
    LogisticsType: 'CVS',
    LogisticsSubType: 'UNIMARTC2C',
    IsCollection: 'N',
    ServerReplyURL: serverReplyURL, // 回調URL
    ExtraData: 'HAZO_VAPE_STORE_SELECTION',
    Device: '0' // 0:PC, 1:Mobile
  };
}
```

### 2. 回調處理 (`backend/routes/stores.js`)

#### 地圖選擇器端點
```javascript
POST /api/stores/map-selector
// 生成ECPay地圖選擇器參數
```

#### 回調處理端點
```javascript
POST /api/stores/map-callback
// 處理ECPay門市選擇回調
```

#### 回調資料處理
```javascript
const storeData = {
  storeId: req.body.CVSStoreID || req.body.storeId || '',
  storeName: req.body.CVSStoreName || req.body.storeName || '',
  storeAddress: req.body.CVSAddress || req.body.storeAddress || '',
  storeTelephone: req.body.CVSTelephone || req.body.storeTelephone || ''
};
```

### 3. 前端組件 (`src/components/StoreSelector.tsx`)

#### 地圖開啟功能
```javascript
const openMapSelector = async (logisticsSubType = 'UNIMARTC2C') => {
  // 1. 呼叫後端API生成地圖參數
  // 2. 創建表單並提交到ECPay
  // 3. 開啟新視窗顯示地圖
  // 4. 監控視窗狀態
};
```

#### 回調監聽機制
```javascript
useEffect(() => {
  // 1. 設定全域回調函數
  window.handleStoreSelection = (storeData) => {
    onStoreSelect(storeData);
  };
  
  // 2. 監聽localStorage變化
  window.addEventListener('storage', handleStorageChange);
  
  // 3. 監聽postMessage
  window.addEventListener('message', handleMessage);
  
  // 4. 檢查現有localStorage資料
  checkExistingStorageData();
});
```

## 多重回調機制

### 1. 主要回調方案

#### localStorage橋接
```javascript
// 回調頁面儲存資料
const storeSelectionData = {
  timestamp: Date.now(),
  storeData: storeData,
  source: 'ecpay_callback'
};
localStorage.setItem('ecpay_store_selection', JSON.stringify(storeSelectionData));

// 主頁面監聽變化
window.addEventListener('storage', (event) => {
  if (event.key === 'ecpay_store_selection') {
    const selectionData = JSON.parse(event.newValue);
    handleStoreSelection(selectionData.storeData);
  }
});
```

### 2. 備用回調方案

#### Window.opener直接回調
```javascript
if (window.opener && typeof window.opener.handleStoreSelection === 'function') {
  window.opener.handleStoreSelection(storeData);
}
```

#### PostMessage通訊
```javascript
window.opener.postMessage({
  type: 'STORE_SELECTION',
  data: storeData
}, '*');
```

#### URL重定向
```javascript
const redirectUrl = `${mainSiteUrl}/checkout?storeId=${storeData.storeId}&storeName=${storeData.storeName}`;
window.location.href = redirectUrl;
```

### 3. 手動回調功能

回調頁面提供手動操作按鈕：
- **重新傳送**: 重試自動回調機制
- **檢查並傳送**: 檢查localStorage並嘗試多種傳送方法
- **複製門市資訊**: 複製門市資料供手動輸入
- **關閉視窗**: 關閉回調視窗

## 安全配置

### Content Security Policy (CSP)

```javascript
// 專用CSP中間件，僅對回調路由放寬限制
const ecpayCallbackCSP = (req, res, next) => {
  if (req.path === '/api/stores/map-callback') {
    res.setHeader('Content-Security-Policy', 
      "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';"
    );
  }
  next();
};
```

### 表單提交安全
```javascript
"form-action": [
  "'self'", 
  "https://logistics.ecpay.com.tw", 
  "https://logistics-stage.ecpay.com.tw"
]
```

## 使用方式

### 1. 結帳頁面整合

```tsx
import { StoreSelector } from '../components/StoreSelector';

const CheckoutPage = () => {
  const handleStoreSelect = (store) => {
    setCustomerInfo(prev => ({
      ...prev,
      storeNumber: store.id,
      storeName: store.name
    }));
  };

  return (
    <StoreSelector
      onStoreSelect={handleStoreSelect}
      selectedStore={selectedStore}
    />
  );
};
```

### 2. 用戶操作流程

1. **開啟地圖**: 用戶點擊"選擇 7-ELEVEN 門市"按鈕
2. **選擇門市**: 在ECPay彈窗地圖中選擇門市
3. **自動回傳**: 系統自動將門市資訊填入表單
4. **手動備用**: 如自動失敗，可使用手動按鈕

### 3. 錯誤處理

#### 自動重試機制
- 最多重試3次
- 30秒內的資料視為有效
- 過期資料自動清理

#### 手動備用方案
- 手動檢查localStorage
- 多種postMessage嘗試
- URL重定向到結帳頁面
- 門市資訊複製功能

## 調試與監控

### 調試日誌

系統在開發者控制台提供詳細日誌：

```javascript
// StoreSelector組件初始化
🔧 StoreSelector useEffect 執行，設定回調函數

// 回調頁面載入
🏪 ECPay 回調頁面載入
📋 門市數據: {storeId: '253576', storeName: '新大業門市', ...}

// localStorage儲存
🔄 使用 localStorage 儲存門市數據

// 主頁面接收
📦 收到 localStorage 變化: ecpay_store_selection
✅ 通過 localStorage 收到有效門市數據

// 表單更新
📍 CheckoutPage 收到門市選擇
✅ handleStoreSelect 執行完成
```

### 故障排除

#### 常見問題

1. **回調頁面空白**
   - 檢查CSP設定是否正確
   - 確認ECPay API參數正確性

2. **門市資料未填入**
   - 檢查localStorage是否有資料
   - 確認回調函數是否正確設定
   - 嘗試手動"檢查並傳送"按鈕

3. **CheckMacValue錯誤**
   - 確認HashKey和HashIV正確
   - 檢查參數排序和編碼
   - 驗證MD5加密流程

#### 檢查步驟

1. 開啟瀏覽器開發者工具
2. 查看Console日誌訊息
3. 檢查Network請求狀態
4. 確認localStorage資料
5. 使用手動按鈕測試

## 版本歷史

### v36 (最新版)
- ✅ 完整多重回調機制
- ✅ 手動檢查和傳送功能
- ✅ URL重定向備用方案
- ✅ 詳細調試日誌

### v35
- ✅ 調試日誌增強
- ✅ 回調函數存在性檢查

### v34
- ✅ localStorage跨標籤頁通訊
- ✅ StorageEvent監聽機制

### v33
- ✅ CSP安全政策修復
- ✅ 內聯腳本執行權限

## 技術支援

### 相關文件
- [ECPay物流API文檔](https://developers.ecpay.com.tw/?p=2856)
- [綠界超商物流API](https://developers.ecpay.com.tw/?p=2502)

### 聯絡資訊
- 開發團隊: HAZO技術部
- 綠界技術支援: 請參考官方文檔

---

*最後更新: 2025-08-19*  
*版本: v36*  
*系統: HAZO Vape 電商平台*